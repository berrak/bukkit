#############################################################################
#
# MAKEFILE for OpenCobol 1.1 (now GnuCOBOL)	applications
#
# Project: <%= projectname %> 	
#
# Enter one of the following commands 
#
#  make <app_name>	  - Builds the program designated by <app_name>
#
#  make all		      - Builds all COBOL programs
#
#  make <user_name>   - Builds all COBOL programs designated by <user_name>
#
#  make dist			Builds all COBOL programs, moves them to build directory
#
#  make install			Installs build files on target system directories
#  
#
#  make clean		   - Erases intermediate files
#  make cleanall	   - Erases all files produced in the build process,
#			             except the original source files
#
# The makefile contains the following sections:
#
#    1 -- VARIABLES
#    2 -- MAKE USER CATEGORIES
#    3 -- MAKE CLEAN COMMANDS
#    4 -- COMMANDS TO MAKE INDIVIDUAL PROGRAMS
#    5 -- PHONY TARGETS
#
#
#############################################################################
#		   1 -- VARIABLES				 
#############################################################################

COBC = /usr/bin/cobc
OBJFLAGS = -c
EXEFLAG = -x
EXT = -ext
QUIET = @

CP = /bin/cp
ECHO = /bin/echo
CHOWN = /bin/chown
ERASE = /bin/rm
FIND = /usr/bin/find
XARGS = /usr/bin/xargs

#############################################################################
#  2 -- MAKE USER CATEGORIES i.e. <user_name>
#	       2a - make all
#	       2b - make bekr
#	       2c - make <other_user>  
#	       .
#          .
#############################################################################


#****************************************************************************
#		   2a - make all
#****************************************************************************

all : \
	gnucobol

#****************************************************************************
#		   2b - make <user_name>=bekr
#****************************************************************************

bekr : \
	gnucobol

#****************************************************************************
#		   2c - make <user_name>=<other_user>
#****************************************************************************

# other_user_name : \
#	otherpgm

#############################################################################
#  3 -- COMMANDS TO CLEAN
#		   3a -  make  clean - Erases intermediate files (*.s, )
#		   3b -  make  cleanall - Erases intermediate files (*.s, ) and erase
#                all files in the build directory
#		   
#############################################################################

#****************************************************************************
#		   3a - make clean (all binary files)
#****************************************************************************
.PHONY: clean cleangen cleanall

clean : \
	cleangen 
 
cleangen :
	$(QUIET) $(ECHO) [makefile]: Remove all generated binary files
	$(QUIET) $(FIND) . -type f -perm -u+x -print0 | $(XARGS) -0 $(ERASE)


#****************************************************************************
#		   3b - make cleanall (+all generated files in build directory
#****************************************************************************

cleanall : \
	clean
	$(QUIET) $(ECHO) [makefile]: Remove all generated binary files in build directory
	$(ERASE) ../build/*
	$(ERASE) ../build/cgi-bin/*


#############################################################################
#  4 -- COMMANDS TO MAKE INDIVIDUAL SAMPLES
#		   4a -  catogori of files (TBD)
#		   4b -  another category of files
#
#############################################################################

#****************************************************************************
#		   4a -  categori TDB
#****************************************************************************

gnucobol: gnucobol.so
	$(COBC) $(EXT) cgi $(EXEFLAG) gnucobol.cbl

gnucobol.so: gnucobol.cbl
	$(COBC) $(COBFLAGS) gnucobol.cbl


#****************************************************************************
#		   4b -  categori TDB
#****************************************************************************


#############################################################################
#  5 -- PHONY TARGETS
#		   5a -  make  dist - Moves files to build directory
#		   5b -  make  install - Installs files to system directories
#
#############################################################################

.PHONY: dist install
dist:
	$(QUIET) $(ECHO) [makefile]: Copy binary files to build directory ../<%= builddirectory %>/cgi-bin
	$(QUIET) $(FIND) . -type f -perm -u+x -print0 | $(XARGS) -0 $(CP) -t ../<%= builddirectory %>/cgi-bin/.
	$(QUIET) $(ECHO) [makefile]: Change ownership of binary files 
	$(QUIET) $(CHOWN) <%= username %>:<%= groupname %> ../<%= builddirectory %>/cgi-bin/*

install:
	$(QUIET) $(ECHO) [makefile]: Install files to target directory <%= cgiinstallpath %>
	$(QUIET) $(CP) ../<%= builddirectory %>/cgi-bin/* <%= cgiinstallpath %>/.
	$(QUIET) $(ECHO) [makefile]: Change ownership of binary files in <%= cgiinstallpath %>
	$(QUIET) $(CHOWN) <%= username %>:<%= groupname %> <%= cgiinstallpath %>/*

